<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Transfer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script>
        // Optional: Tailwind Customization
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'header-bg': '#ffffff', 'sidebar-bg': '#f8f9fa',
                        'primary-blue': '#0d6efd', 'secondary-gray': '#6c757d',
                        'light-gray': '#f1f3f5', 'border-gray': '#dee2e6',
                        'text-dark': '#212529', 'text-muted': '#6c757d',
                        'status-approved': '#198754', 'status-pending': '#ffc107',
                        'status-rejected': '#dc3545', 'modal-overlay': 'rgba(0, 0, 0, 0.5)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles (same as before) */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .nav-link-active { color: #0d6efd; border-bottom: 2px solid #0d6efd; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-track { background-color: #f1f3f5; }
        .actions-dropdown-menu { z-index: 50; }
        .status-badge { padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; display: inline-block; }
        .status-approved { background-color: #d1e7dd; color: #0f5132; }
        .status-pending { background-color: #fff3cd; color: #664d03; }
        .status-rejected { background-color: #f8d7da; color: #842029; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 998; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 550px; background-color: white; z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; box-shadow: -2px 0 8px rgba(0,0,0,0.1); }
        .modal-panel.open { transform: translateX(0); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-header { padding: 1rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 1.5rem; }
        .modal-footer { padding: 1rem; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; background-color: #f8f9fa; }
        .detail-table th, .detail-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #dee2e6; vertical-align: top; }
        .detail-table th { font-weight: 500; color: #6c757d; width: 150px; text-align: left; }
        .detail-table td { color: #212529; }
        .detail-table tr:last-child th, .detail-table tr:last-child td { border-bottom: none; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #495057; }
        .form-label .required { color: #dc3545; margin-left: 2px; }
        .form-input, .form-select { display: block; width: 100%; padding: 0.5rem 0.75rem; font-size: 0.875rem; line-height: 1.5; color: #495057; background-color: #fff; background-clip: padding-box; border: 1px solid #ced4da; border-radius: 0.375rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-input:focus, .form-select:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25); }
        .date-input-container { position: relative; }
        .date-input-icon { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); pointer-events: none; color: #6c757d; }
        /* Loading indicator style */
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-light-gray">

    <header class="bg-header-bg shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-8">
                <div class="text-xl font-bold text-primary-blue">Logo</div>
                <ul class="hidden md:flex items-center space-x-6">
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Dashboard</a></li>
                    <li><a href="#" class="text-text-dark hover:text-primary-blue py-2 nav-link-active font-medium">Employees</a></li>
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Time Management</a></li>
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Finance</a></li>
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Payroll</a></li>
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Company</a></li>
                    <li><a href="#" class="text-text-muted hover:text-primary-blue py-2">Benefit</a></li>
                </ul>
            </div>
            <div class="flex items-center space-x-4">
                <button class="bg-primary-blue text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 flex items-center space-x-1"><i class="fas fa-chart-pie text-xs"></i> <span>Summarize data</span></button>
                <button class="text-text-muted hover:text-primary-blue"><i class="fas fa-bell"></i></button>
                <button class="text-text-muted hover:text-primary-blue"><i class="fas fa-question-circle"></i></button>
                <button class="text-text-muted hover:text-primary-blue"><i class="fas fa-user-circle text-xl"></i></button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-semibold text-text-dark mb-6">Employee transfer</h1>

        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-text-muted mb-1">Status</label>
                    <select id="status-filter" class="w-full border border-border-gray rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-blue focus:border-primary-blue">
                        <option value="">All status</option>
                        <option value="Approved">Approved</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label for="effective-date-filter" class="block text-sm font-medium text-text-muted mb-1">Effective date</label>
                    <input type="date" id="effective-date-filter" class="w-full border border-border-gray rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-blue focus:border-primary-blue" placeholder="Select effective date">
                </div>
                <div>
                    <button class="w-full border border-border-gray rounded-lg px-3 py-2 text-sm text-text-muted hover:bg-gray-50 flex items-center justify-center space-x-1">
                        <i class="fas fa-filter text-xs"></i> <span>All filters</span>
                    </button>
                </div>
                <div class="lg:col-span-2">
                    <label for="search-employee" class="block text-sm font-medium text-text-muted mb-1">Search</label>
                    <div class="relative">
                        <input type="text" id="search-employee" class="w-full border border-border-gray rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-blue focus:border-primary-blue" placeholder="Search employee...">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-text-muted text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0 md:space-x-3">
                <div class="flex-grow"></div>
                <div class="flex space-x-3">
                    <button class="border border-border-gray rounded-lg px-4 py-2 text-sm text-text-muted hover:bg-gray-50 flex items-center space-x-1"><i class="fas fa-upload text-xs"></i> <span>Export</span></button>
                    <button class="border border-border-gray rounded-lg px-4 py-2 text-sm text-text-muted hover:bg-gray-50 flex items-center space-x-1"><i class="fas fa-download text-xs"></i> <span>Import</span></button>
                    <button id="create-transfer-button" class="bg-primary-blue text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 flex items-center space-x-1"><i class="fas fa-plus text-xs"></i> <span>Create transfer</span></button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="table-container overflow-x-auto">
                <table class="w-full min-w-[1000px] text-sm text-left text-text-dark">
                    <thead class="text-xs text-text-muted uppercase bg-light-gray border-b border-border-gray">
                        <tr>
                            <th scope="col" class="px-6 py-3">Transaction ID</th>
                            <th scope="col" class="px-6 py-3">Employee name</th>
                            <th scope="col" class="px-6 py-3">Employee ID</th>
                            <th scope="col" class="px-6 py-3">Transfer type</th>
                            <th scope="col" class="px-6 py-3">Created date</th>
                            <th scope="col" class="px-6 py-3">Effective date</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3">Attachment</th>
                            <th scope="col" class="px-6 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transfer-table-body">
                        <tr><td colspan="9" class="text-center py-4"><div class="loading-spinner"></div>Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-center px-6 py-3 bg-white border-t border-border-gray text-sm text-text-muted">
                <div class="flex items-center space-x-2 mb-2 md:mb-0">
                    <span>Rows per page:</span>
                    <select id="rows-per-page" class="border border-border-gray rounded px-2 py-1 text-xs focus:outline-none">
                        <option value="10">10</option> <option value="25">25</option> <option value="50">50</option>
                    </select>
                    <span id="pagination-info">Showing 0-0 of 0</span> </div>
                <div class="flex items-center space-x-2">
                    <button id="prev-page" class="border border-border-gray rounded px-2 py-1 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled> <i class="fas fa-chevron-left text-xs"></i> </button>
                    <span>Page</span>
                    <input type="number" id="current-page" value="1" min="1" class="border border-border-gray rounded w-12 px-2 py-1 text-center text-xs focus:outline-none">
                    <span id="total-pages">of 1</span> <button id="next-page" class="border border-border-gray rounded px-2 py-1 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled> <i class="fas fa-chevron-right text-xs"></i> </button>
                </div>
            </div>
        </div>
    </main>

    <div id="detail-modal-overlay" class="modal-overlay"></div>
    <div id="transfer-detail-modal" class="modal-panel">
        <div class="modal-header">
            <h2 class="text-lg font-semibold text-text-dark">Transfer detail</h2>
            <button id="close-detail-modal-button" class="text-text-muted hover:text-text-dark"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="modal-body space-y-6">
            <div class="flex items-center space-x-3">
                <img id="modal-employee-img" src="https://placehold.co/40x40/" alt="Employee" class="w-10 h-10 rounded-full object-cover">
                <div>
                    <p id="modal-employee-name" class="font-semibold text-text-dark"></p>
                    <p id="modal-employee-id" class="text-sm text-text-muted"></p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div class="text-text-muted">Transaction ID</div><div id="modal-transaction-id" class="text-text-dark font-medium"></div>
                <div class="text-text-muted">Effective date</div><div id="modal-effective-date" class="text-text-dark"></div>
                <div class="text-text-muted">Transfer Type</div><div id="modal-transfer-type" class="text-text-dark"></div>
                <div class="text-text-muted">Status</div>
                <div> <span id="modal-status-badge" class="status-badge"></span> <a href="#" class="ml-2 text-xs text-primary-blue hover:underline">See approval history</a> </div>
            </div>
            <div>
                <div class="bg-blue-50 border-l-4 border-primary-blue p-3 text-sm text-blue-800 mb-4 rounded-r-md"> <i class="fas fa-info-circle mr-1"></i> Only data that contains changes will appear... </div>
                <div class="border border-border-gray rounded-lg overflow-hidden">
                    <table class="w-full detail-table">
                        <thead class="bg-light-gray"> <tr> <th class="font-semibold text-text-muted uppercase text-xs">Type</th> <th class="font-semibold text-text-muted uppercase text-xs">From</th> <th class="font-semibold text-text-muted uppercase text-xs">To</th> </tr> </thead>
                        <tbody id="modal-changes-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="create-modal-overlay" class="modal-overlay"></div>
    <div id="create-transfer-modal" class="modal-panel">
        <div class="modal-header">
            <h2 class="text-lg font-semibold text-text-dark">Employee transfer</h2>
            <button id="close-create-modal-button" class="text-text-muted hover:text-text-dark"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="create-transfer-form" class="modal-body space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="md:col-span-3">
                    <label for="create-employee" class="form-label">Employees <span class="required">*</span></label>
                    <select id="create-employee" name="employee" class="form-select" required>
                        <option value="" disabled selected>Loading employees...</option>
                        </select>
                </div>
                <div>
                    <label for="create-effective-date" class="form-label">Effective date <span class="required">*</span></label>
                     <div class="date-input-container">
                        <input type="date" id="create-effective-date" name="effective_date" class="form-input" required>
                        <i class="fas fa-calendar-alt date-input-icon"></i>
                    </div>
                </div>
                <div>
                    <label for="create-transfer-type" class="form-label">Transfer type <span class="required">*</span></label>
                    <select id="create-transfer-type" name="transfer_type" class="form-select" required>
                        <option value="" disabled selected>Select transfer type</option>
                        <option value="Mutation">Mutation</option> <option value="Promotion">Promotion</option> <option value="Demotion">Demotion</option> <option value="Other">Other</option>
                    </select>
                </div>
                 <div>
                    <label for="create-group-structure" class="form-label">Group structure</label>
                    <select id="create-group-structure" name="group_structure" class="form-select">
                        <option value="" disabled selected>Select group structure</option>
                        <option value="Structure A">Structure A</option> <option value="Structure B">Structure B</option>
                    </select>
                     <p class="text-xs text-text-muted mt-1">This setting will help you... <a href="#" class="text-primary-blue hover:underline">Go to settings</a></p>
                </div>
            </div>
            <div>
                <h3 class="text-base font-semibold text-text-dark mb-2">Manage transfer</h3>
                <p class="text-sm text-text-muted mb-4">You can select one of the fields to transfer.</p>
                <div class="space-y-4">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-employment-status" class="form-label">Employment status</label><select id="create-employment-status" name="employment_status" class="form-select"><option value="" selected>Select Employment Status</option><option value="Permanent">Permanent</option><option value="Contract">Contract</option><option value="Intern">Intern</option></select></div><div></div></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-branch" class="form-label">Branch</label><select id="create-branch" name="branch" class="form-select"><option value="" selected>Select Branch</option><option value="Branch A">Branch A</option><option value="Branch B">Branch B</option></select></div><div><label for="create-organization" class="form-label">Organization</label><select id="create-organization" name="organization" class="form-select"><option value="" selected>Select Organization</option><option value="Sales">Sales</option><option value="Marketing">Marketing</option><option value="Engineering">Engineering</option></select></div></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-job-position" class="form-label">Job position</label><select id="create-job-position" name="job_position" class="form-select"><option value="" selected>Select Job position</option><option value="Manager">Manager</option><option value="Developer">Developer</option><option value="Analyst">Analyst</option></select></div><div><label for="create-job-level" class="form-label">Job level</label><select id="create-job-level" name="job_level" class="form-select"><option value="" selected>Select Job level</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option></select></div></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-grade" class="form-label">Grade</label><select id="create-grade" name="grade" class="form-select"><option value="" selected>Select Grade</option><option value="G1">G1</option><option value="G2">G2</option></select></div><div><label for="create-class" class="form-label">Class</label><select id="create-class" name="class" class="form-select"><option value="" selected>Select Class</option><option value="C1">C1</option><option value="C2">C2</option></select></div></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-cost-center" class="form-label">Cost Center</label><select id="create-cost-center" name="cost_center" class="form-select"><option value="" selected>Select Cost center</option><option value="CC100">CC100</option><option value="CC200">CC200</option></select></div><div><label for="create-cost-center-category" class="form-label">Cost Center Category</label><select id="create-cost-center-category" name="cost_center_category" class="form-select"><option value="" selected>Select Cost center category</option><option value="Cat A">Cat A</option><option value="Cat B">Cat B</option></select></div></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="create-approval-line" class="form-label">Approval line</label><select id="create-approval-line" name="approval_line" class="form-select"><option value="" selected>Select approval line</option><option value="Line 1">Line 1</option><option value="Line 2">Line 2</option></select></div><div><label for="create-manager" class="form-label">Manager</label><select id="create-manager" name="manager" class="form-select"><option value="" selected>Select manager</option><option value="Manager A">Manager A</option><option value="Manager B">Manager B</option></select></div></div>
                </div>
            </div>
        </form>
        <div class="modal-footer space-x-3">
            <button type="button" id="cancel-create-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
            <button type="submit" form="create-transfer-form" class="px-4 py-2 text-sm font-medium text-white bg-primary-blue border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // !!! IMPORTANT: Replace this with your Deployed Google Apps Script Web App URL !!!
            const SCRIPT_URL = "https://script.google.com/a/macros/hibank.co.id/s/AKfycbygUdmJWtu0hT-5F7vRXHrABvtPGVnn8XkBG08qowfP56kcIKPMSZdzzaZvOzPTmk40Nw/exec";

            // --- Element References ---
            const tableBody = document.getElementById('transfer-table-body');
            const employeeSelect = document.getElementById('create-employee');
            const paginationInfo = document.getElementById('pagination-info');
            const currentPageInput = document.getElementById('current-page');
            const totalPagesSpan = document.getElementById('total-pages');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            // Detail Modal Elements
            const detailModalOverlay = document.getElementById('detail-modal-overlay');
            const detailModalPanel = document.getElementById('transfer-detail-modal');
            const closeDetailModalButton = document.getElementById('close-detail-modal-button');
            // Create Modal Elements
            const createModalOverlay = document.getElementById('create-modal-overlay');
            const createModalPanel = document.getElementById('create-transfer-modal');
            const createTransferButton = document.getElementById('create-transfer-button');
            const closeCreateModalButton = document.getElementById('close-create-modal-button');
            const cancelCreateButton = document.getElementById('cancel-create-button');
            const createTransferForm = document.getElementById('create-transfer-form');

            // --- State ---
            let allTransfers = []; // To store all fetched transfer data
            let currentTransfers = []; // To store filtered/sorted data for display
            let employees = []; // To store fetched employee list
            let currentPage = 1;
            let rowsPerPage = 10; // Or get from #rows-per-page select

            // --- Data Fetching ---
            async function fetchData() {
                showLoading();
                // Check if SCRIPT_URL is set
                if (SCRIPT_URL === "https://script.google.com/a/macros/hibank.co.id/s/AKfycbygUdmJWtu0hT-5F7vRXHrABvtPGVnn8XkBG08qowfP56kcIKPMSZdzzaZvOzPTmk40Nw/exec" || !SCRIPT_URL) {
                   showError("Please set the SCRIPT_URL in the JavaScript code.");
                   console.error("SCRIPT_URL not set.");
                   return;
                }

                // Construct the URL with parameters for different actions
                const transferUrl = `${SCRIPT_URL}?action=getTransfers`;
                const employeeUrl = `${SCRIPT_URL}?action=getEmployees`;

                try {
                    // Fetch transfers and employees concurrently
                    const [transferResponse, employeeResponse] = await Promise.all([
                        fetch(transferUrl),
                        fetch(employeeUrl)
                    ]);

                    if (!transferResponse.ok || !employeeResponse.ok) {
                        throw new Error(`HTTP error! status: ${transferResponse.status} / ${employeeResponse.status}`);
                    }

                    const transferData = await transferResponse.json();
                    const employeeData = await employeeResponse.json();

                    console.log("Fetched Transfers:", transferData);
                    console.log("Fetched Employees:", employeeData);

                    if (transferData.success && employeeData.success) {
                        allTransfers = transferData.data;
                        employees = employeeData.data;
                        currentTransfers = [...allTransfers]; // Initially display all
                        populateEmployeeDropdown(employees);
                        renderTable(); // Initial render
                    } else {
                         showError("Failed to fetch data from script.");
                         console.error("API Error:", transferData.error || employeeData.error);
                    }

                } catch (error) {
                    showError(`Error fetching data: ${error.message}`);
                    console.error("Fetch Error:", error);
                } finally {
                    hideLoading();
                }
            }

            // --- Table Rendering & Pagination ---
             function renderTable() {
                tableBody.innerHTML = ''; // Clear previous rows or loading indicator
                if (currentTransfers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">No transfer data found.</td></tr>';
                    updatePaginationControls(0); // Update pagination for empty state
                    return;
                }

                // Calculate pagination
                const totalItems = currentTransfers.length;
                const totalPages = Math.ceil(totalItems / rowsPerPage);
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                const paginatedTransfers = currentTransfers.slice(startIndex, endIndex);

                paginatedTransfers.forEach(transfer => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b border-border-gray hover:bg-gray-50';
                    // Add data attributes for the detail modal
                    row.dataset.transactionId = transfer.transactionId || '';
                    row.dataset.employeeName = transfer.employeeName || '';
                    row.dataset.employeeId = transfer.employeeId || '';
                    row.dataset.transferType = transfer.transferType || '';
                    row.dataset.createdDate = transfer.createdDate || '';
                    row.dataset.effectiveDate = transfer.effectiveDate || '';
                    row.dataset.status = transfer.status || '';
                    row.dataset.attachment = transfer.attachment || 'false'; // Assuming boolean or link

                    // Determine status badge class
                    const statusClass = `status-${(transfer.status || '').toLowerCase()}`;

                    row.innerHTML = `
                        <td class="px-6 py-4 text-primary-blue font-medium">${transfer.transactionId || 'N/A'}</td>
                        <td class="px-6 py-4">${transfer.employeeName || 'N/A'}</td>
                        <td class="px-6 py-4">${transfer.employeeId || 'N/A'}</td>
                        <td class="px-6 py-4">${transfer.transferType || 'N/A'}</td>
                        <td class="px-6 py-4">${transfer.createdDate || 'N/A'}</td>
                        <td class="px-6 py-4">${transfer.effectiveDate || 'N/A'}</td>
                        <td class="px-6 py-4"><span class="status-badge ${statusClass}">${transfer.status || 'N/A'}</span></td>
                        <td class="px-6 py-4 text-center">${transfer.attachment ? '<a href="#" class="text-primary-blue hover:underline" title="View Attachment"><i class="fas fa-paperclip"></i></a>' : '-'}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="relative inline-block text-left">
                                <button type="button" class="actions-button text-primary-blue hover:underline inline-flex justify-center items-center w-full rounded-md px-2 py-1 text-sm font-medium focus:outline-none" aria-haspopup="true" aria-expanded="false">
                                    Actions <i class="fas fa-chevron-down text-xs ml-1"></i>
                                </button>
                                <div class="actions-dropdown-menu hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none">
                                    <div class="py-1" role="menu">
                                        <a href="#" class="detail-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Detail</a>
                                        <a href="#" class="cancel-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Cancel Transfer</a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                updatePaginationControls(totalItems);
            }

            function updatePaginationControls(totalItems) {
                const totalPages = Math.ceil(totalItems / rowsPerPage);
                totalPagesSpan.textContent = `of ${totalPages || 1}`;
                currentPageInput.max = totalPages || 1;
                currentPageInput.value = currentPage;

                // Update "Showing x-y of z" text
                 const startItem = totalItems === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
                 const endItem = Math.min(startItem + rowsPerPage - 1, totalItems);
                 paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems}`;


                // Enable/disable buttons
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage === totalPages || totalItems === 0;
            }

             function changePage(newPage) {
                const totalPages = Math.ceil(currentTransfers.length / rowsPerPage);
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderTable();
                }
             }

            // --- Employee Dropdown Population ---
            function populateEmployeeDropdown(employeeList) {
                employeeSelect.innerHTML = '<option value="" disabled selected>Select employee</option>'; // Clear existing and add placeholder
                if (employeeList && employeeList.length > 0) {
                    employeeList.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id; // Assuming employee object has 'id' and 'name'
                        option.textContent = `${emp.name} (${emp.id})`;
                        employeeSelect.appendChild(option);
                    });
                } else {
                     employeeSelect.innerHTML = '<option value="" disabled selected>No employees found</option>';
                }
            }

            // --- Loading and Error Indicators ---
            function showLoading() {
                 tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><div class="loading-spinner"></div>Loading data...</td></tr>';
            }
            function hideLoading() {
                // Loading is hidden implicitly when renderTable clears the tbody
            }
             function showError(message) {
                 tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-red-600 py-4 font-medium">${message}</td></tr>`;
                 updatePaginationControls(0); // Reset pagination on error
            }


            // --- Dropdown Logic (Table Actions) ---
            function setupActionDropdowns() {
                 tableBody.addEventListener('click', (event) => {
                    const target = event.target;
                    const actionButton = target.closest('.actions-button');
                    const detailLink = target.closest('.detail-link');
                    const cancelLink = target.closest('.cancel-link');

                    if (actionButton) {
                        event.stopPropagation();
                        const dropdownMenu = actionButton.nextElementSibling;
                        const isExpanded = !dropdownMenu.classList.contains('hidden');
                        closeAllDropdowns(dropdownMenu);
                        dropdownMenu.classList.toggle('hidden');
                        actionButton.setAttribute('aria-expanded', String(!isExpanded));
                    } else if (detailLink) {
                        event.preventDefault();
                        const row = detailLink.closest('tr');
                        if (row) openDetailModal(row.dataset);
                        closeAllDropdowns();
                    } else if (cancelLink) {
                         event.preventDefault();
                         console.log('Cancel Transfer clicked for:', cancelLink.closest('tr').dataset.transactionId);
                         alert(`Simulating Cancel Transfer for ID: ${cancelLink.closest('tr').dataset.transactionId}`); // Replace with actual logic
                         closeAllDropdowns();
                    }
                });
            }
            function closeAllDropdowns(exceptMenu = null) {
                document.querySelectorAll('.actions-dropdown-menu').forEach(menu => {
                    if (menu !== exceptMenu && !menu.classList.contains('hidden')) {
                        menu.classList.add('hidden');
                        const button = menu.previousElementSibling;
                        if (button) button.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            window.addEventListener('click', (event) => {
                 if (!event.target.closest('.actions-dropdown-menu') && !event.target.closest('.actions-button')) { closeAllDropdowns(); }
            });

            // --- Detail Modal Logic ---
            function openDetailModal(data) {
                // Populate modal fields
                document.getElementById('modal-employee-name').textContent = data.employeeName || 'N/A';
                document.getElementById('modal-employee-id').textContent = data.employeeId || 'N/A';
                document.getElementById('modal-transaction-id').textContent = data.transactionId || 'N/A';
                document.getElementById('modal-effective-date').textContent = data.effectiveDate || 'N/A';
                document.getElementById('modal-transfer-type').textContent = data.transferType || 'N/A';
                const statusBadge = document.getElementById('modal-status-badge');
                statusBadge.textContent = data.status || 'N/A';
                statusBadge.className = `status-badge status-${(data.status || '').toLowerCase()}`;
                const initials = (data.employeeName || '??').split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('modal-employee-img').src = `https://placehold.co/40x40/0d6efd/ffffff?text=${initials}`;
                document.getElementById('modal-employee-img').alt = data.employeeName || 'Employee';

                // Populate Changes Table (Placeholder - Fetch real data here if needed)
                const changesTableBody = document.getElementById('modal-changes-table-body');
                changesTableBody.innerHTML = '';
                const changes = getTransferChanges(data.transactionId); // Placeholder
                if (Object.keys(changes).length > 0) {
                     for (const type in changes) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<th>${type}</th><td>${changes[type].from || '-'}</td><td>${changes[type].to || '-'}</td>`;
                        changesTableBody.appendChild(row);
                    }
                } else {
                     changesTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-text-muted italic py-4">No specific changes listed</td></tr>`;
                }

                // Show modal
                detailModalOverlay.classList.add('open');
                detailModalPanel.classList.add('open');
            }
            function closeDetailModal() {
                detailModalOverlay.classList.remove('open');
                detailModalPanel.classList.remove('open');
            }
            function getTransferChanges(transactionId) { // Placeholder
                console.log("Simulating fetch detail changes for:", transactionId);
                if (transactionId === '2025050200001') return {'Branch': { from: 'Old Branch A', to: 'New Branch B' },'Job position': { from: 'Junior Dev', to: 'Senior Dev' }};
                return {};
            }
            closeDetailModalButton.addEventListener('click', closeDetailModal);
            detailModalOverlay.addEventListener('click', closeDetailModal);

            // --- Create Modal Logic ---
            function openCreateModal() {
                createTransferForm.reset();
                // Ensure employee dropdown is populated (in case it wasn't loaded initially)
                if (employeeSelect.options.length <= 1 && employees.length > 0) {
                    populateEmployeeDropdown(employees);
                } else if (employeeSelect.options.length <= 1) {
                     employeeSelect.innerHTML = '<option value="" disabled selected>Could not load employees</option>';
                }
                createModalOverlay.classList.add('open');
                createModalPanel.classList.add('open');
            }
            function closeCreateModal() {
                createModalOverlay.classList.remove('open');
                createModalPanel.classList.remove('open');
            }
            createTransferForm.addEventListener('submit', async (event) => { // Made async
                event.preventDefault();
                console.log('Create Transfer form submitted');

                 // Check if SCRIPT_URL is set
                if (SCRIPT_URL === "YOUR_DEPLOYED_APPS_SCRIPT_WEB_APP_URL_HERE" || !SCRIPT_URL) {
                   alert("SCRIPT_URL not set in JavaScript. Cannot submit form.");
                   console.error("SCRIPT_URL not set.");
                   return;
                }

                const formData = new FormData(createTransferForm);
                const data = Object.fromEntries(formData.entries());
                console.log('Form Data:', data);

                // Disable button during submission
                const saveButton = createTransferForm.nextElementSibling.querySelector('button[type="submit"]');
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';


                try {
                    // Construct URL for the create action
                     const createUrl = `${SCRIPT_URL}?action=createTransfer`;
                     const response = await fetch(createUrl, {
                        method: 'POST',
                        // Apps Script web apps often expect payload as stringified form data
                        // Adjust 'Content-Type' and body format based on your Apps Script doGet/doPost handling
                        headers: {
                           // 'Content-Type': 'application/json', // Use if Apps Script expects JSON
                           'Content-Type': 'application/x-www-form-urlencoded', // Common for Apps Script POST
                        },
                        // body: JSON.stringify(data), // Use if sending JSON
                         body: new URLSearchParams(data).toString() // Send as form data
                     });

                     if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                     }

                     const result = await response.json();
                     console.log("Create Result:", result);

                     if(result.success) {
                        alert('Transfer created successfully! (Simulated)'); // Replace with better notification
                        closeCreateModal();
                        fetchData(); // Refresh the table data
                     } else {
                         alert(`Failed to create transfer: ${result.error || 'Unknown error'}`);
                     }

                } catch (error) {
                     alert(`Error submitting form: ${error.message}`);
                     console.error("Submit Error:", error);
                } finally {
                     // Re-enable button
                     saveButton.disabled = false;
                     saveButton.textContent = 'Save';
                }
            });
            createTransferButton.addEventListener('click', openCreateModal);
            closeCreateModalButton.addEventListener('click', closeCreateModal);
            cancelCreateButton.addEventListener('click', closeCreateModal);
            createModalOverlay.addEventListener('click', closeCreateModal);

             // --- Event Listeners for Pagination & Filtering ---
             prevPageButton.addEventListener('click', () => changePage(currentPage - 1));
             nextPageButton.addEventListener('click', () => changePage(currentPage + 1));
             currentPageInput.addEventListener('change', (e) => {
                 const newPage = parseInt(e.target.value, 10);
                 if (!isNaN(newPage)) {
                     changePage(newPage);
                 } else {
                     // Reset if invalid input
                     e.target.value = currentPage;
                 }
             });
             document.getElementById('rows-per-page').addEventListener('change', (e) => {
                 rowsPerPage = parseInt(e.target.value, 10);
                 currentPage = 1; // Reset to first page
                 renderTable();
             });
             // Add listeners for filter inputs (status, date, search) here
             // They should modify 'currentTransfers' and call renderTable()


            // --- Initial Load ---
            console.log("Employee Transfer page loaded. Fetching data...");
            setupActionDropdowns(); // Setup listeners using event delegation
            fetchData(); // Fetch initial data on load

        });
    </script>

</body>
</html>
